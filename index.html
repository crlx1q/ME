<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tasco | Ultimate Workspace</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="shortcut icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tasco">
    <meta name="theme-color" content="#8b5cf6">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --tasco-bg: #000000;
            --tasco-bg-soft: #09090b;
            --tasco-card: rgba(18, 18, 18, 0.7);
            --tasco-panel: rgba(8, 8, 8, 0.85);
            --tasco-border: rgba(255, 255, 255, 0.08);
            --tasco-text: #e4e4e7;
            --tasco-muted: #a1a1aa;
            --tasco-accent: #8b5cf6;
            --tasco-accent-soft: rgba(139, 92, 246, 0.15);
            --tasco-accent-strong: #a855f7;
            --tasco-accent-border: rgba(139, 92, 246, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tasco-bg);
            color: var(--tasco-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body[data-theme='dark'] {
            --tasco-bg: #0f172a;
            --tasco-bg-soft: #111827;
            --tasco-card: rgba(17, 24, 39, 0.85);
            --tasco-panel: rgba(15, 23, 42, 0.95);
            --tasco-border: rgba(255, 255, 255, 0.08);
            --tasco-text: #f1f5f9;
            --tasco-muted: #cbd5f5;
        }

        body[data-theme='light'] {
            --tasco-bg: #f8fafc;
            --tasco-bg-soft: #f1f5f9;
            --tasco-card: rgba(255, 255, 255, 0.9);
            --tasco-panel: rgba(255, 255, 255, 0.92);
            --tasco-border: rgba(15, 23, 42, 0.08);
            --tasco-text: #0f172a;
            --tasco-muted: #475569;
        }

        body[data-accent='violet'] {
            --tasco-accent: #8b5cf6;
            --tasco-accent-soft: rgba(139, 92, 246, 0.15);
            --tasco-accent-strong: #a855f7;
            --tasco-accent-border: rgba(139, 92, 246, 0.2);
        }

        body[data-accent='blue'] {
            --tasco-accent: #3b82f6;
            --tasco-accent-soft: rgba(59, 130, 246, 0.15);
            --tasco-accent-strong: #2563eb;
            --tasco-accent-border: rgba(59, 130, 246, 0.2);
        }

        body[data-accent='emerald'] {
            --tasco-accent: #34d399;
            --tasco-accent-soft: rgba(52, 211, 153, 0.15);
            --tasco-accent-strong: #10b981;
            --tasco-accent-border: rgba(52, 211, 153, 0.2);
        }

        body[data-accent='rose'] {
            --tasco-accent: #fb7185;
            --tasco-accent-soft: rgba(251, 113, 133, 0.15);
            --tasco-accent-strong: #f43f5e;
            --tasco-accent-border: rgba(251, 113, 133, 0.2);
        }

        body[data-accent='orange'] {
            --tasco-accent: #fb923c;
            --tasco-accent-soft: rgba(251, 146, 60, 0.15);
            --tasco-accent-strong: #f97316;
            --tasco-accent-border: rgba(251, 146, 60, 0.2);
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }

        /* Glassmorphism Utilities */
        .glass {
            background: var(--tasco-card);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border: 1px solid var(--tasco-border);
        }
        .glass-panel {
            background: var(--tasco-panel);
            backdrop-filter: blur(14px);
            border-right: 1px solid var(--tasco-border);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--tasco-border);
            color: var(--tasco-text);
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            border-color: var(--tasco-accent);
            background: var(--tasco-accent-soft);
            box-shadow: 0 0 0 4px var(--tasco-accent-soft);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }

        /* Amoled Optimization */
        .accent-chip {
            background-color: var(--tasco-accent-soft);
            color: var(--tasco-accent);
        }

        .accent-button {
            background-color: var(--tasco-accent);
            color: #fff;
        }

        .accent-button:hover {
            background-color: var(--tasco-accent-strong);
        }

        .accent-outline {
            border-color: var(--tasco-accent);
            color: var(--tasco-accent);
        }

        .theme-border {
            border-color: var(--tasco-border);
        }

        .theme-bg {
            background-color: var(--tasco-bg);
            color: var(--tasco-text);
        }

        .accent-hover:hover {
            background-color: var(--tasco-accent) !important;
            color: #fff !important;
        }
    </style>
</head>
<body class="bg-amoled text-gray-200 selection:bg-violet-500 selection:text-white h-screen overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const API_URL = window.__API_URL__ || 'http://localhost:5000';

        // --- ICONS (SVG Components for crisp look) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                check: <path d="M20 6L9 17l-5-5"/>,
                square: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>,
                list: <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>,
                grid: (
                    <>
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </>
                ),
                file: (
                    <>
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </>
                ),
                settings: (
                    <>
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </>
                ),
                moon: (
                    <path d="M21 12.8A9 9 0 1 1 11.2 3 7 7 0 0 0 21 12.8z"/>
                ),
                logOut: (
                    <>
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </>
                ),
                plus: (
                    <>
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </>
                ),
                trash: (
                    <>
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </>
                ),
                chevronRight: <polyline points="9 18 15 12 9 6"/>,
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
                image: (
                    <>
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </>
                )
            };
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="1.5" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name]}
                </svg>
            );
        };

        // --- APP COMPONENT ---
        const THEME_OPTIONS = [
            { id: 'amoled', label: 'AMOLED' },
            { id: 'dark', label: 'Dark' },
            { id: 'light', label: 'Light' }
        ];

        const ACCENT_OPTIONS = [
            { id: 'violet', label: 'Violet', swatch: 'bg-violet-500' },
            { id: 'blue', label: 'Blue', swatch: 'bg-blue-500' },
            { id: 'emerald', label: 'Emerald', swatch: 'bg-emerald-500' },
            { id: 'rose', label: 'Rose', swatch: 'bg-rose-500' },
            { id: 'orange', label: 'Orange', swatch: 'bg-orange-500' }
        ];

        const App = () => {
            const savedToken = typeof window !== 'undefined'
                ? localStorage.getItem('tasco_token') || sessionStorage.getItem('tasco_token')
                : null;
            const [authStep, setAuthStep] = useState(savedToken ? 2 : 0); // 0: Login, 1: 2FA, 2: App
            const [activeTab, setActiveTab] = useState('tasks');
            const [data, setData] = useState({
                tasks: [],
                projects: [],
                notes: []
            });
            const [token, setToken] = useState(savedToken);
            const [pendingUserId, setPendingUserId] = useState(null);
            const [userId, setUserId] = useState(null);
            const [account, setAccount] = useState({ username: '', isTwoFAEnabled: false });
            const [preferences, setPreferences] = useState({ theme: 'amoled', accent: 'violet' });
            const [sessions, setSessions] = useState([]);
            const [currentSessionId, setCurrentSessionId] = useState(null);
            const [twoFASetup, setTwoFASetup] = useState({ qrCode: null, secret: null });

            // Login Form State
            const [login, setLogin] = useState('');
            const [pass, setPass] = useState('');
            const [code, setCode] = useState('');
            const [error, setError] = useState('');
            const [remember, setRemember] = useState(false);
            const [loading, setLoading] = useState(false);
            const [projectsLoading, setProjectsLoading] = useState(false);
            const [projectsMutating, setProjectsMutating] = useState(false);
            const [tasksLoading, setTasksLoading] = useState(false);
            const [tasksMutating, setTasksMutating] = useState(false);
            const [notesLoading, setNotesLoading] = useState(false);
            const [notesMutating, setNotesMutating] = useState(false);

            useEffect(() => {
                if (typeof document !== 'undefined') {
                    document.body.setAttribute('data-theme', preferences.theme);
                }
            }, [preferences.theme]);

            useEffect(() => {
                if (typeof document !== 'undefined') {
                    document.body.setAttribute('data-accent', preferences.accent);
                }
            }, [preferences.accent]);

            // --- DATA FETCHING ---
            const fetchProjects = useCallback(async (authToken) => {
                if (!authToken) return;
                setProjectsLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/projects`, {
                        headers: {
                            Authorization: `Bearer ${authToken}`
                        }
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось загрузить проекты');
                    }
                    setData(prev => ({ ...prev, projects: payload }));
                } catch (err) {
                    setError(err.message || 'Не удалось загрузить проекты');
                } finally {
                    setProjectsLoading(false);
                }
            }, [checkAuthError]);

            const fetchTasks = useCallback(async (authToken) => {
                if (!authToken) return;
                setTasksLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/tasks`, {
                        headers: {
                            Authorization: `Bearer ${authToken}`
                        }
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось загрузить задачи');
                    }
                    setData(prev => ({ ...prev, tasks: payload }));
                } catch (err) {
                    setError(err.message || 'Не удалось загрузить задачи');
                } finally {
                    setTasksLoading(false);
                }
            }, [checkAuthError]);

            const fetchNotes = useCallback(async (authToken) => {
                if (!authToken) return;
                setNotesLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/notes`, {
                        headers: {
                            Authorization: `Bearer ${authToken}`
                        }
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось загрузить заметки');
                    }
                    setData(prev => ({ ...prev, notes: payload }));
                } catch (err) {
                    setError(err.message || 'Не удалось загрузить заметки');
                } finally {
                    setNotesLoading(false);
                }
            }, [checkAuthError]);

            const fetchAccount = useCallback(async (authToken) => {
                if (!authToken) return;
                try {
                    const res = await fetch(`${API_URL}/api/account`, {
                        headers: {
                            Authorization: `Bearer ${authToken}`
                        }
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось загрузить профиль');
                    }
                    setAccount({ username: payload.username, isTwoFAEnabled: payload.isTwoFAEnabled });
                    setPreferences(payload.preferences || { theme: 'amoled', accent: 'violet' });
                    setUserId(payload.userId);
                } catch (err) {
                    setError(err.message || 'Не удалось загрузить профиль');
                }
            }, [checkAuthError]);

            const fetchSessions = useCallback(async (authToken) => {
                if (!authToken) return;
                try {
                    const res = await fetch(`${API_URL}/api/sessions`, {
                        headers: {
                            Authorization: `Bearer ${authToken}`
                        }
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось получить сессии');
                    }
                    setSessions(payload.sessions || []);
                    setCurrentSessionId(payload.currentSessionId || null);
                } catch (err) {
                    setError(err.message || 'Не удалось получить сессии');
                }
            }, [checkAuthError]);

            const fetchAllData = useCallback(async (authToken) => {
                await Promise.allSettled([
                    fetchProjects(authToken),
                    fetchTasks(authToken),
                    fetchNotes(authToken),
                    fetchAccount(authToken),
                    fetchSessions(authToken)
                ]);
            }, [fetchProjects, fetchTasks, fetchNotes, fetchAccount, fetchSessions]);

            useEffect(() => {
                if (token) {
                    fetchAllData(token);
                }
            }, [token, fetchAllData]);

            // Функция для принудительного выхода при ошибке аутентификации
            const forceLogout = useCallback(() => {
                localStorage.removeItem('tasco_token');
                sessionStorage.removeItem('tasco_token');
                setToken(null);
                setAuthStep(0);
                setLogin(''); 
                setPass(''); 
                setCode('');
                setData({ tasks: [], projects: [], notes: [] });
                setPendingUserId(null);
                setSessions([]);
                setCurrentSessionId(null);
                setAccount({ username: '', isTwoFAEnabled: false });
                setPreferences({ theme: 'amoled', accent: 'violet' });
                setUserId(null);
                setTwoFASetup({ qrCode: null, secret: null });
                setError('');
            }, []);

            // Функция для проверки статуса сессии
            const checkSessionStatus = useCallback(async (authToken) => {
                if (!authToken) return;
                try {
                    const res = await fetch(`${API_URL}/api/auth/check-session`, {
                        headers: {
                            Authorization: `Bearer ${authToken}`
                        }
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        // Сессия неактивна - принудительный выход
                        forceLogout();
                    }
                } catch (err) {
                    // При ошибке сети не делаем ничего, чтобы не выходить при временных проблемах
                    console.warn('Session check failed:', err);
                }
            }, [checkAuthError, forceLogout]);

            // Периодическая проверка статуса сессии (каждые 5 секунд)
            useEffect(() => {
                if (!token || authStep !== 2) return;

                // Проверяем сразу при монтировании
                checkSessionStatus(token);

                // Затем проверяем каждые 5 секунд
                const interval = setInterval(() => {
                    checkSessionStatus(token);
                }, 5000);

                return () => clearInterval(interval);
            }, [token, authStep, checkSessionStatus]);

            // Функция для проверки ошибок аутентификации
            const checkAuthError = useCallback((res, payload) => {
                if (res.status === 401 || (payload && (payload.error === 'Auth failed' || payload.error === 'Сессия устарела. Войдите заново.'))) {
                    forceLogout();
                    return true;
                }
                return false;
            }, [forceLogout]);

            const persistToken = (jwtToken, meta = {}) => {
                setToken(jwtToken);
                if (meta.sessionId) {
                    setCurrentSessionId(meta.sessionId);
                }
                if (remember) {
                    localStorage.setItem('tasco_token', jwtToken);
                    sessionStorage.removeItem('tasco_token');
                } else {
                    sessionStorage.setItem('tasco_token', jwtToken);
                    localStorage.removeItem('tasco_token');
                }
                setAuthStep(2);
                fetchAllData(jwtToken);
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: login.trim(), password: pass })
                    });
                    const payload = await res.json();
                    if (!res.ok) {
                        throw new Error(payload.error || 'Ошибка авторизации');
                    }
                    if (payload.require2FA) {
                        setPendingUserId(payload.userId);
                        setAccount(prev => ({ ...prev, username: payload.username || login.trim() }));
                        setAuthStep(1);
                        setError('');
                        return;
                    }
                    setUserId(payload.userId);
                    setAccount({ username: payload.username || login.trim(), isTwoFAEnabled: payload.isTwoFAEnabled });
                    setPreferences(payload.preferences || { theme: 'amoled', accent: 'violet' });
                    persistToken(payload.token, { sessionId: payload.sessionId });
                } catch (err) {
                    setError(err.message || 'Ошибка авторизации');
                } finally {
                    setLoading(false);
                }
            };

            const handle2FA = async (e) => {
                e.preventDefault();
                if(!pendingUserId) {
                    setError('Сессия 2FA устарела, войдите заново');
                    setAuthStep(0);
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/2fa/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: pendingUserId, token: code })
                    });
                    const payload = await res.json();
                    if (!res.ok || !payload.success) {
                        throw new Error(payload.error || 'Неверный код');
                    }
                    const resolvedUserId = payload.userId || pendingUserId;
                    setUserId(resolvedUserId);
                    setAccount(prev => ({
                        username: prev.username || login.trim(),
                        isTwoFAEnabled: payload.isTwoFAEnabled ?? true
                    }));
                    if (payload.preferences) {
                        setPreferences(payload.preferences);
                    }
                    persistToken(payload.token, { sessionId: payload.sessionId });
                    setPendingUserId(null);
                    setTwoFASetup({ qrCode: null, secret: null });
                } catch (err) {
                    setError(err.message || 'Неверный код');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                try {
                    if (token) {
                        await fetch(`${API_URL}/api/auth/logout`, {
                            method: 'POST',
                            headers: {
                                Authorization: `Bearer ${token}`
                            }
                        });
                    }
                } catch (logoutErr) {
                    console.warn('Logout error', logoutErr);
                }

                localStorage.removeItem('tasco_token');
                sessionStorage.removeItem('tasco_token');
                setAuthStep(0);
                setLogin(''); setPass(''); setCode('');
                setToken(null);
                setData({ tasks: [], projects: [], notes: [] });
                setPendingUserId(null);
                setSessions([]);
                setCurrentSessionId(null);
                setAccount({ username: '', isTwoFAEnabled: false });
                setPreferences({ theme: 'amoled', accent: 'violet' });
                setUserId(null);
                setTwoFASetup({ qrCode: null, secret: null });
                setError('');
            };

            const handleCreateProject = async (title) => {
                if (!token) return;
                setProjectsMutating(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/projects`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ title })
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось создать проект');
                    }
                    setData(prev => ({ ...prev, projects: [payload, ...prev.projects] }));
                } catch (err) {
                    setError(err.message || 'Не удалось создать проект');
                } finally {
                    setProjectsMutating(false);
                }
            };

            const handleProjectItemsUpdate = async (projectId, itemsBuilder) => {
                if (!token || !projectId) return;
                const project = data.projects.find(p => (p._id ?? p.id) === projectId);
                if (!project) return;
                const nextItems = typeof itemsBuilder === 'function' ? itemsBuilder(project.items || []) : itemsBuilder;

                setProjectsMutating(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/projects/${projectId}/items`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ items: nextItems })
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось обновить проект');
                    }
                    setData(prev => ({
                        ...prev,
                        projects: prev.projects.map(p => (p._id ?? p.id) === projectId ? payload : p)
                    }));
                } catch (err) {
                    setError(err.message || 'Не удалось обновить проект');
                } finally {
                    setProjectsMutating(false);
                }
            };

            const handleCreateTask = async ({ text, deadline }) => {
                if (!token) return;
                setTasksMutating(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/tasks`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ text, deadline })
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось создать задачу');
                    }
                    setData(prev => ({ ...prev, tasks: [payload, ...prev.tasks] }));
                } catch (err) {
                    setError(err.message || 'Не удалось создать задачу');
                } finally {
                    setTasksMutating(false);
                }
            };

            const handleToggleTask = async (taskId, nextDone) => {
                if (!token) return;
                setTasksMutating(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/tasks/${taskId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ done: nextDone })
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось обновить задачу');
                    }
                    setData(prev => ({
                        ...prev,
                        tasks: prev.tasks.map(t => (t._id ?? t.id) === taskId ? payload : t)
                    }));
                } catch (err) {
                    setError(err.message || 'Не удалось обновить задачу');
                } finally {
                    setTasksMutating(false);
                }
            };

            const handleDeleteTask = async (taskId) => {
                if (!token) return;
                setTasksMutating(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/tasks/${taskId}`, {
                        method: 'DELETE',
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    });
                    if (res.status === 204) {
                        setData(prev => ({ ...prev, tasks: prev.tasks.filter(t => (t._id ?? t.id) !== taskId) }));
                        return;
                    }
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось удалить задачу');
                    }
                    setData(prev => ({ ...prev, tasks: prev.tasks.filter(t => (t._id ?? t.id) !== taskId) }));
                } catch (err) {
                    setError(err.message || 'Не удалось удалить задачу');
                } finally {
                    setTasksMutating(false);
                }
            };

            const handleCreateNote = async () => {
                if (!token) return;
                setNotesMutating(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/notes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ title: 'Новая заметка', content: '' })
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось создать заметку');
                    }
                    setData(prev => ({ ...prev, notes: [payload, ...prev.notes] }));
                } catch (err) {
                    setError(err.message || 'Не удалось создать заметку');
                } finally {
                    setNotesMutating(false);
                }
            };

            const handleUpdateNote = async (noteId, updates) => {
                if (!token) return;
                setNotesMutating(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/notes/${noteId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify(updates)
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось обновить заметку');
                    }
                    setData(prev => ({
                        ...prev,
                        notes: prev.notes.map(n => (n._id ?? n.id) === noteId ? payload : n)
                    }));
                } catch (err) {
                    setError(err.message || 'Не удалось обновить заметку');
                } finally {
                    setNotesMutating(false);
                }
            };

            const handleDeleteNote = async (noteId) => {
                if (!token) return;
                setNotesMutating(true);
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/notes/${noteId}`, {
                        method: 'DELETE',
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    });
                    if (res.status === 204) {
                        setData(prev => ({ ...prev, notes: prev.notes.filter(n => (n._id ?? n.id) !== noteId) }));
                        return;
                    }
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось удалить заметку');
                    }
                    setData(prev => ({ ...prev, notes: prev.notes.filter(n => (n._id ?? n.id) !== noteId) }));
                } catch (err) {
                    setError(err.message || 'Не удалось удалить заметку');
                } finally {
                    setNotesMutating(false);
                }
            };

            const updatePreferences = async (payload) => {
                if (!token || !payload || !Object.keys(payload).length) return;
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/account/preferences`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });
                    const updated = await res.json();
                    if (checkAuthError(res, updated)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(updated.error || 'Не удалось обновить настройки');
                    }
                    setPreferences(updated);
                } catch (err) {
                    setError(err.message || 'Не удалось обновить настройки');
                }
            };

            const handleThemeChange = (themeKey) => {
                if (themeKey === preferences.theme) return;
                updatePreferences({ theme: themeKey });
            };

            const handleAccentChange = (accentKey) => {
                if (accentKey === preferences.accent) return;
                updatePreferences({ accent: accentKey });
            };

            const startTwoFASetup = async () => {
                if (!token || !userId) return;
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/2fa/setup`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ userId })
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось подготовить 2FA');
                    }
                    setTwoFASetup({ qrCode: payload.qrCode, secret: payload.secret });
                } catch (err) {
                    setError(err.message || 'Не удалось подготовить 2FA');
                }
            };

            const verifyTwoFASetup = async (codeValue) => {
                if (!codeValue || !userId) return;
                setError('');
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}/api/2fa/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId, token: codeValue })
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok || !payload.success) {
                        throw new Error(payload.error || 'Неверный код');
                    }
                    setAccount(prev => ({ username: prev.username || account.username, isTwoFAEnabled: true }));
                    if (payload.preferences) {
                        setPreferences(payload.preferences);
                    }
                    persistToken(payload.token, { sessionId: payload.sessionId });
                    setTwoFASetup({ qrCode: null, secret: null });
                } catch (err) {
                    setError(err.message || 'Не удалось подтвердить 2FA');
                } finally {
                    setLoading(false);
                }
            };

            const disableTwoFA = async () => {
                if (!token) return;
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/2fa/disable`, {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось отключить 2FA');
                    }
                    setAccount(prev => ({ ...prev, isTwoFAEnabled: false }));
                    setTwoFASetup({ qrCode: null, secret: null });
                } catch (err) {
                    setError(err.message || 'Не удалось отключить 2FA');
                }
            };

            const revokeSession = async (sessionId) => {
                if (!token) return;
                setError('');
                try {
                    const res = await fetch(`${API_URL}/api/sessions/${sessionId}`, {
                        method: 'DELETE',
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    });
                    const payload = await res.json();
                    if (checkAuthError(res, payload)) {
                        return;
                    }
                    if (!res.ok) {
                        throw new Error(payload.error || 'Не удалось завершить сессию');
                    }
                    if (payload.revokedCurrent) {
                        await handleLogout();
                        return;
                    }
                    fetchSessions(token);
                } catch (err) {
                    setError(err.message || 'Не удалось завершить сессию');
                }
            };

            // --- UI RENDERERS ---

            if (authStep < 2) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
                        {/* Background Glows */}
                        <div className="absolute top-[-20%] left-[-10%] w-[500px] h-[500px] bg-violet-600/20 rounded-full blur-[120px]"></div>
                        <div className="absolute bottom-[-20%] right-[-10%] w-[500px] h-[500px] bg-blue-600/10 rounded-full blur-[120px]"></div>

                        <div className="glass w-full max-w-md rounded-3xl p-8 relative z-10 animate-fade-in shadow-2xl">
                            <div className="flex justify-center mb-8">
                                <img src="/logo.png" alt="Tasco" className="w-16 h-16 rounded-2xl shadow-lg shadow-violet-500/20" />
                            </div>
                            
                            <h1 className="text-2xl font-bold text-center mb-2">Welcome Back</h1>
                            <p className="text-center text-zinc-500 text-sm mb-8">Вход в защищенное пространство Tasco</p>

                            {authStep === 0 ? (
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div>
                                        <label className="text-xs text-zinc-400 ml-1 mb-1 block">Логин</label>
                                        <input type="text" value={login} onChange={e=>setLogin(e.target.value)} className="w-full glass-input rounded-xl px-4 py-3 text-sm text-white outline-none" placeholder="username" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-zinc-400 ml-1 mb-1 block">Пароль</label>
                                        <input type="password" value={pass} onChange={e=>setPass(e.target.value)} className="w-full glass-input rounded-xl px-4 py-3 text-sm text-white outline-none" placeholder="••••••" />
                                    </div>
                                    <div className="flex items-center gap-2 my-2">
                                        <div 
                                            onClick={() => setRemember(!remember)}
                                            className={`w-5 h-5 rounded border border-zinc-700 cursor-pointer flex items-center justify-center transition-colors ${remember ? 'bg-violet-500 border-violet-500' : 'bg-transparent'}`}
                                        >
                                            {remember && <Icon name="check" size={12} />}
                                        </div>
                                        <span className="text-sm text-zinc-400 cursor-pointer" onClick={() => setRemember(!remember)}>Не выходить из системы</span>
                                    </div>
                                    {error && <p className="text-rose-500 text-xs text-center">{error}</p>}
                                    <button disabled={loading} className="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200 transition-colors mt-4 disabled:opacity-40">
                                        {loading ? 'Входим...' : 'Войти'}
                                    </button>
                                </form>
                            ) : (
                                <form onSubmit={handle2FA} className="space-y-6">
                                    <div className="text-center">
                                        <div className="inline-block p-4 rounded-full bg-violet-500/10 mb-2">
                                            <Icon name="shield" size={32} className="text-violet-400" />
                                        </div>
                                        <h3 className="text-lg font-medium">Google Authenticator</h3>
                                        <p className="text-xs text-zinc-500 mt-1">Введите 6 цифр из приложения</p>
                                    </div>
                                    <input 
                                        type="text" maxLength="6" value={code} onChange={e=>setCode(e.target.value.replace(/\D/g,''))}
                                        className="w-full glass-input text-center text-3xl tracking-[0.5em] py-4 rounded-xl font-mono"
                                        placeholder="000000" autoFocus
                                    />
                                    {error && <p className="text-rose-500 text-xs text-center">{error}</p>}
                                    <button disabled={loading} className="w-full bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white font-bold py-3 rounded-xl hover:opacity-90 transition-opacity shadow-lg shadow-violet-600/20 disabled:opacity-50">
                                        {loading ? 'Проверяем...' : 'Подтвердить'}
                                    </button>
                                    <button type="button" onClick={() => setAuthStep(0)} className="w-full text-zinc-500 text-sm hover:text-white transition-colors">Назад</button>
                                </form>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <Dashboard 
                    onLogout={handleLogout} 
                    activeTab={activeTab} 
                    setActiveTab={setActiveTab}
                    data={data}
                    projectsLoading={projectsLoading}
                    projectsMutating={projectsMutating}
                    tasksLoading={tasksLoading}
                    tasksMutating={tasksMutating}
                    notesLoading={notesLoading}
                    notesMutating={notesMutating}
                    onCreateProject={handleCreateProject}
                    onUpdateProjectItems={handleProjectItemsUpdate}
                    onCreateTask={handleCreateTask}
                    onToggleTask={handleToggleTask}
                    onDeleteTask={handleDeleteTask}
                    onCreateNote={handleCreateNote}
                    onUpdateNote={handleUpdateNote}
                    onDeleteNote={handleDeleteNote}
                    error={error}
                    preferences={preferences}
                    account={account}
                    themeOptions={THEME_OPTIONS}
                    accentOptions={ACCENT_OPTIONS}
                    onChangeTheme={handleThemeChange}
                    onChangeAccent={handleAccentChange}
                    onStartTwoFA={startTwoFASetup}
                    onVerifyTwoFA={verifyTwoFASetup}
                    onDisableTwoFA={disableTwoFA}
                    twoFASetup={twoFASetup}
                    sessions={sessions}
                    currentSessionId={currentSessionId}
                    onRevokeSession={revokeSession}
                />
            );
        };

        // --- DASHBOARD COMPONENT ---
        const Dashboard = ({
            onLogout,
            activeTab,
            setActiveTab,
            data,
            projectsLoading,
            projectsMutating,
            tasksLoading,
            tasksMutating,
            notesLoading,
            notesMutating,
            onCreateProject,
            onUpdateProjectItems,
            onCreateTask,
            onToggleTask,
            onDeleteTask,
            onCreateNote,
            onUpdateNote,
            onDeleteNote,
            error,
            preferences,
            account,
            themeOptions,
            accentOptions,
            onChangeTheme,
            onChangeAccent,
            onStartTwoFA,
            onVerifyTwoFA,
            onDisableTwoFA,
            twoFASetup,
            sessions,
            currentSessionId,
            onRevokeSession
        }) => {
            const [mobileMenu, setMobileMenu] = useState(false);

            const NavItem = ({ id, icon, label }) => (
                <button 
                    onClick={() => {setActiveTab(id); setMobileMenu(false);}}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-sm font-medium ${activeTab === id ? '' : 'text-zinc-500 hover:text-zinc-300 hover:bg-white/5'}`}
                    style={activeTab === id ? {
                        backgroundColor: 'var(--tasco-accent-soft)',
                        color: 'var(--tasco-accent)',
                        border: '1px solid var(--tasco-accent-border)'
                    } : {}}
                >
                    <Icon name={icon} size={18} />
                    {label}
                </button>
            );

            return (
                <div className="flex h-screen theme-bg">
                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 glass-panel transform transition-transform duration-300 md:relative md:translate-x-0 flex flex-col ${mobileMenu ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-8">
                                <img src="/logo.png" alt="Tasco" className="w-8 h-8 rounded-lg" />
                                <span className="font-bold text-xl tracking-tight">Tasco</span>
                            </div>
                            <nav className="space-y-1">
                                <NavItem id="tasks" icon="check" label="Мои задачи" />
                                <NavItem id="projects" icon="grid" label="Проекты" />
                                <NavItem id="notes" icon="file" label="Заметки" />
                                <NavItem id="settings" icon="settings" label="Настройки" />
                            </nav>
                        </div>
                        <div className="mt-auto p-6 border-t border-white/5">
                            <div className="flex items-center gap-3 mb-4 px-2">
                                <div className="w-8 h-8 rounded-full bg-zinc-800 border border-zinc-700 flex items-center justify-center text-xs font-bold">AD</div>
                                <div className="flex-1 min-w-0">
                                    <div className="text-sm font-medium truncate">{account?.username || 'AlisherDEV'}</div>
                                    <div className="text-xs text-zinc-500">Личный доступ</div>
                                </div>
                            </div>
                            <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-2 rounded-lg text-rose-500/80 hover:text-rose-500 hover:bg-rose-500/10 text-sm transition-colors">
                                <Icon name="logOut" size={16} />
                                Выйти
                            </button>
                        </div>
                    </aside>
                    
                    {/* Mobile Overlay */}
                    {mobileMenu && <div className="fixed inset-0 bg-black/80 z-40 md:hidden" onClick={()=>setMobileMenu(false)}></div>}

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                        <div className="absolute top-0 left-0 w-full h-[200px] bg-gradient-to-b from-violet-900/10 to-transparent pointer-events-none"></div>

                        {/* Mobile Header */}
                        <div className="md:hidden p-4 flex items-center justify-between border-b border-white/5 bg-black/50 backdrop-blur-xl sticky top-0 z-30">
                            <div className="flex items-center gap-2">
                                <img src="/logo.png" alt="Tasco" className="w-6 h-6 rounded" />
                                <span className="font-bold">Tasco</span>
                            </div>
                            <button onClick={()=>setMobileMenu(true)}><Icon name="list" /></button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                            <div className="max-w-4xl mx-auto animate-fade-in">
                                {error && <div className="mb-4 text-center text-rose-400 text-sm glass py-2 rounded-xl">{error}</div>}
                                {activeTab === 'tasks' && (
                                    <TasksView 
                                        tasks={data.tasks}
                                        onCreateTask={onCreateTask}
                                        onToggleTask={onToggleTask}
                                        onDeleteTask={onDeleteTask}
                                        tasksLoading={tasksLoading}
                                        tasksMutating={tasksMutating}
                                    />
                                )}
                                {activeTab === 'projects' && (
                                    <ProjectsView 
                                        data={data} 
                                        projectsLoading={projectsLoading}
                                        projectsMutating={projectsMutating}
                                        onCreateProject={onCreateProject}
                                        onUpdateProjectItems={onUpdateProjectItems}
                                    />
                                )}
                                {activeTab === 'notes' && (
                                    <NotesView 
                                        notes={data.notes}
                                        onCreateNote={onCreateNote}
                                        onUpdateNote={onUpdateNote}
                                        onDeleteNote={onDeleteNote}
                                        notesLoading={notesLoading}
                                        notesMutating={notesMutating}
                                    />
                                )}
                                {activeTab === 'settings' && (
                                    <SettingsView 
                                        preferences={preferences}
                                        account={account}
                                        themeOptions={themeOptions}
                                        accentOptions={accentOptions}
                                        onChangeTheme={onChangeTheme}
                                        onChangeAccent={onChangeAccent}
                                        onStartTwoFA={onStartTwoFA}
                                        onVerifyTwoFA={onVerifyTwoFA}
                                        onDisableTwoFA={onDisableTwoFA}
                                        twoFASetup={twoFASetup}
                                        sessions={sessions}
                                        onRevokeSession={onRevokeSession}
                                        currentSessionId={currentSessionId}
                                    />
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // --- VIEWS ---
        
        const TasksView = ({ tasks, onCreateTask, onToggleTask, onDeleteTask, tasksLoading, tasksMutating }) => {
            const [text, setText] = useState('');
            const [deadline, setDeadline] = useState('');

            const addTask = (e) => {
                e.preventDefault();
                if(!text.trim()) return;
                onCreateTask({ text: text.trim(), deadline: deadline || undefined });
                setText('');
                setDeadline('');
            };

            const formatDate = (value) => {
                if (!value) return null;
                try {
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) return null;
                    return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch {
                    return null;
                }
            };

            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Сегодня</h2>
                    <form onSubmit={addTask} className="mb-8 relative group grid gap-3 md:grid-cols-[1fr_auto]">
                        <div className="absolute inset-0 rounded-2xl blur opacity-20 group-hover:opacity-30 transition-opacity md:col-span-2" style={{ background: `linear-gradient(to right, var(--tasco-accent), var(--tasco-accent-strong))` }}></div>
                        <div className="relative glass rounded-2xl p-1 flex items-center md:col-span-1">
                            <input 
                                type="text"
                                value={text}
                                onChange={e=>setText(e.target.value)}
                                placeholder="Добавить новую задачу..." 
                                className="flex-1 bg-transparent border-none outline-none px-4 text-white placeholder-zinc-500 h-12"
                            />
                        </div>
                        <div className="relative glass rounded-2xl p-1 flex items-center gap-2 md:justify-end">
                            <input 
                                type="date"
                                value={deadline}
                                onChange={(e) => setDeadline(e.target.value)}
                                className="bg-transparent border-none outline-none px-4 text-sm text-zinc-300 placeholder-zinc-500 h-12 flex-1"
                            />
                            <button disabled={tasksMutating} className="h-10 w-10 bg-zinc-800 rounded-xl flex items-center justify-center accent-hover transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                                <Icon name="plus" size={20} />
                            </button>
                        </div>
                    </form>

                    <div className="flex items-center gap-3 text-xs text-zinc-500 mb-4">
                        {tasksLoading && <span>Загружаем задачи...</span>}
                        {tasksMutating && <span>Сохраняем изменения...</span>}
                    </div>

                    <div className="space-y-3">
                        {tasks.map(task => {
                            const taskId = task._id ?? task.id;
                            const deadlineLabel = formatDate(task.deadline);
                            return (
                                <div key={taskId} className={`group flex items-center gap-4 p-4 rounded-xl glass border-transparent hover:border-white/10 transition-all ${task.done ? 'opacity-40' : ''}`}>
                                    <button onClick={() => onToggleTask(taskId, !task.done)} className={`w-6 h-6 rounded-lg border transition-all flex items-center justify-center ${task.done ? 'bg-violet-500 border-violet-500' : 'border-zinc-600 hover:border-zinc-400'}`}>
                                        {task.done && <Icon name="check" size={14} className="text-white" />}
                                    </button>
                                    <div className="flex-1">
                                        <span className={`block text-sm ${task.done ? 'line-through text-zinc-500' : ''}`}>{task.text}</span>
                                        {deadlineLabel && (
                                            <div className={`text-xs mt-1 ${task.done ? 'text-zinc-600' : 'text-zinc-400'}`}>
                                                {deadlineLabel}
                                            </div>
                                        )}
                                    </div>
                                    <button onClick={() => onDeleteTask(taskId)} className="opacity-0 group-hover:opacity-100 text-zinc-500 hover:text-rose-500 transition-all">
                                        <Icon name="trash" size={16} />
                                    </button>
                                </div>
                            );
                        })}
                        {tasks.length === 0 && !tasksLoading && <p className="text-center text-zinc-600 py-10">Список пуст. Наслаждайтесь свободой!</p>}
                    </div>
                </div>
            );
        };

        const ProjectsView = ({ data, projectsLoading, projectsMutating, onCreateProject, onUpdateProjectItems }) => {
            const [activeProjectId, setActiveProjectId] = useState(null);
            const [inputLine, setInputLine] = useState('');
            const activeProject = data.projects.find(p => (p._id ?? p.id) === activeProjectId) || null;

            useEffect(() => {
                if (!activeProjectId) return;
                const exists = data.projects.some(p => (p._id ?? p.id) === activeProjectId);
                if (!exists) {
                    setActiveProjectId(null);
                }
            }, [data.projects, activeProjectId]);

            const handleCreateProject = () => {
                const title = prompt('Название нового проекта');
                if (!title?.trim()) return;
                onCreateProject(title.trim());
            };

            const projectKey = (project) => project._id ?? project.id;

            const mutateItems = async (builder) => {
                if (!activeProject) return;
                await onUpdateProjectItems(projectKey(activeProject), builder);
            };

            // Функция для сжатия изображения
            const compressImage = (file, maxWidth = 1920, maxHeight = 1920, quality = 0.7) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            // Масштабирование если изображение слишком большое
                            if (width > maxWidth || height > maxHeight) {
                                const ratio = Math.min(maxWidth / width, maxHeight / height);
                                width = width * ratio;
                                height = height * ratio;
                            }

                            canvas.width = width;
                            canvas.height = height;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            // Конвертируем в JPEG для лучшего сжатия (или сохраняем оригинальный формат если PNG нужен)
                            const mimeType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                            const compressedDataUrl = canvas.toDataURL(mimeType, quality);
                            resolve(compressedDataUrl);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            // Paste Image Handler
            const handlePaste = async (e) => {
                const items = e.clipboardData.items;
                for(let item of items) {
                    if(item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        try {
                            // Сжимаем изображение перед сохранением
                            const compressedDataUrl = await compressImage(blob);
                            const newItem = { 
                                id: crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`, 
                                type: 'image', 
                                content: compressedDataUrl 
                            };
                            mutateItems(prev => [...prev, newItem]);
                        } catch (error) {
                            console.error('Ошибка при сжатии изображения:', error);
                            // Fallback: сохраняем оригинал если сжатие не удалось
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const newItem = { 
                                    id: crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`, 
                                    type: 'image', 
                                    content: event.target.result 
                                };
                                mutateItems(prev => [...prev, newItem]);
                            };
                            reader.readAsDataURL(blob);
                        }
                    }
                }
            };

            const addLine = async (e) => {
                e.preventDefault();
                if(!inputLine.trim()) return;
                const newItem = { id: crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`, type: 'text', content: inputLine.trim(), done: false };
                await mutateItems(prev => [...prev, newItem]);
                setInputLine('');
            };

            if (activeProject) {
                return (
                    <div className="animate-fade-in h-full flex flex-col">
                        <div className="flex items-center gap-4 mb-6">
                            <button onClick={() => setActiveProjectId(null)} className="w-10 h-10 rounded-xl glass flex items-center justify-center hover:bg-white/10">
                                <div className="transform rotate-180"><Icon name="chevronRight" /></div>
                            </button>
                            <h2 className="text-2xl font-bold">{activeProject.title}</h2>
                        </div>

                        {/* Editor Area */}
                        <div className="glass rounded-2xl p-1 mb-6">
                             <form onSubmit={addLine} className="flex items-center">
                                <input 
                                    type="text" 
                                    value={inputLine}
                                    onChange={e => setInputLine(e.target.value)}
                                    onPaste={handlePaste}
                                    className="flex-1 bg-transparent border-none outline-none px-4 py-3 text-white placeholder-zinc-500"
                                    placeholder="Пиши идею, баг или жми Ctrl+V для фото..."
                                    autoFocus
                                />
                                <button type="submit" className="mr-2 p-2 rounded-lg bg-zinc-800 accent-hover transition-colors">
                                    <Icon name="plus" size={16} />
                                </button>
                             </form>
                        </div>

                        <div className="space-y-2 pb-20">
                            {activeProject.items.map(item => (
                                <div key={item.id} className="group flex items-start gap-3 p-3 rounded-xl hover:bg-white/5 transition-colors">
                                    {item.type === 'text' ? (
                                        <>
                                            <div className={`mt-1 w-4 h-4 rounded border cursor-pointer flex items-center justify-center ${item.done ? 'bg-violet-500 border-violet-500' : 'border-zinc-600'}`}
                                                onClick={async () => {
                                                    await mutateItems(prev => prev.map(i => i.id === item.id ? { ...i, done: !i.done } : i));
                                                }}
                                            >
                                                {item.done && <Icon name="check" size={10} className="text-white" />}
                                            </div>
                                            <span className={`flex-1 text-sm break-words ${item.done ? 'line-through text-zinc-500' : 'text-zinc-200'}`}>{item.content}</span>
                                        </>
                                    ) : (
                                        <div className="flex-1">
                                            <div className="relative rounded-xl overflow-hidden border border-white/10 inline-block">
                                                <img src={item.content} alt="upload" className="max-h-[300px] object-contain bg-black/50" />
                                            </div>
                                        </div>
                                    )}
                                <button 
                                        onClick={async () => {
                                            await mutateItems(prev => prev.filter(i => i.id !== item.id));
                                        }}
                                        className="opacity-0 group-hover:opacity-100 p-1 text-zinc-500 hover:text-rose-500"
                                    >
                                        <Icon name="trash" size={14} />
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Проекты</h2>
                    <div className="flex items-center gap-3 mb-4 text-sm text-zinc-500">
                        {projectsLoading && <span>Загружаем проекты...</span>}
                        {projectsMutating && <span>Синхронизируем изменения...</span>}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div 
                            className="glass rounded-2xl p-6 flex flex-col items-center justify-center min-h-[160px] border-dashed border-zinc-700 hover:border-zinc-500 cursor-pointer transition-all group"
                            onClick={projectsMutating ? undefined : handleCreateProject}
                        >
                            <div className="w-12 h-12 rounded-full bg-zinc-800 flex items-center justify-center mb-3 accent-hover transition-colors">
                                <Icon name="plus" />
                            </div>
                            <span className="text-sm font-medium text-zinc-400">{projectsMutating ? 'Подождите...' : 'Новый проект'}</span>
                        </div>

                        {data.projects.map(p => (
                            <div key={projectKey(p)} onClick={() => setActiveProjectId(projectKey(p))} className="glass rounded-2xl p-6 cursor-pointer card-hover relative overflow-hidden group">
                                <div className="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Icon name="chevronRight" className="text-zinc-500" />
                                </div>
                                <div className="w-10 h-10 rounded-lg bg-violet-500/20 flex items-center justify-center mb-4 text-violet-400">
                                    <Icon name="grid" size={20} />
                                </div>
                                <h3 className="font-bold text-lg mb-1">{p.title}</h3>
                                <p className="text-xs text-zinc-500">{p.items.length} элементов</p>
                                
                                {/* Mini progress bar */}
                                <div className="mt-4 h-1 w-full bg-zinc-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-violet-500" style={{ width: `${p.items.length ? (p.items.filter(i=>i.done).length/p.items.length)*100 : 0}%` }}></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const NotesView = ({ notes, onCreateNote, onUpdateNote, onDeleteNote, notesLoading, notesMutating }) => {
            return (
                <div className="animate-fade-in">
                    <div className="flex items-center justify-between mb-6 flex-wrap gap-3">
                        <h2 className="text-3xl font-bold">Заметки</h2>
                        <button 
                            onClick={onCreateNote}
                            disabled={notesMutating}
                            className="flex items-center gap-2 px-4 py-2 rounded-xl glass text-sm hover:bg-white/10 transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
                        >
                            <Icon name="plus" size={16} />
                            Создать заметку
                        </button>
                    </div>

                    <div className="flex items-center gap-3 text-xs text-zinc-500 mb-4">
                        {notesLoading && <span>Загружаем заметки...</span>}
                        {notesMutating && <span>Сохраняем изменения...</span>}
                    </div>

                    {notes.length === 0 && !notesLoading ? (
                        <div className="text-center text-zinc-600 py-20">Пока заметок нет. Создайте первую идею.</div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {notes.map(note => {
                                const noteId = note._id ?? note.id;
                                const stamp = note.updatedAt || note.createdAt;
                                return (
                                    <div key={noteId} className="p-5 rounded-2xl glass flex flex-col gap-3">
                                        <input 
                                            key={`${noteId}-title-${note.updatedAt}`}
                                            type="text"
                                            defaultValue={note.title}
                                            onBlur={(e) => {
                                                const value = e.target.value;
                                                if (value !== note.title) {
                                                    onUpdateNote(noteId, { title: value });
                                                }
                                            }}
                                            className="bg-transparent font-bold text-lg outline-none w-full"
                                            placeholder="Заголовок"
                                        />
                                        <textarea 
                                            key={`${noteId}-content-${note.updatedAt}`}
                                            defaultValue={note.content}
                                            onBlur={(e) => {
                                                const value = e.target.value;
                                                if (value !== note.content) {
                                                    onUpdateNote(noteId, { content: value });
                                                }
                                            }}
                                            className="bg-transparent text-sm text-zinc-300 resize-none outline-none flex-1 min-h-[120px]"
                                            placeholder="Пишите здесь..."
                                        />
                                        <div className="flex justify-between items-center text-xs text-zinc-500">
                                            <span>{stamp ? new Date(stamp).toLocaleString('ru-RU') : ''}</span>
                                            <button onClick={() => onDeleteNote(noteId)} className="text-zinc-500 hover:text-rose-500 transition-colors">
                                                <Icon name="trash" size={16} />
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const SettingsView = ({
            preferences,
            account,
            themeOptions,
            accentOptions,
            onChangeTheme,
            onChangeAccent,
            onStartTwoFA,
            onVerifyTwoFA,
            onDisableTwoFA,
            twoFASetup,
            sessions,
            onRevokeSession,
            currentSessionId
        }) => {
            const [twoFACode, setTwoFACode] = useState('');

            const formatDateTime = (value) => {
                if (!value) return '—';
                try {
                    return new Date(value).toLocaleString('ru-RU', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                } catch {
                    return value;
                }
            };

            return (
                <div className="animate-fade-in max-w-2xl">
                    <h2 className="text-3xl font-bold mb-8">Настройки</h2>

                    <section className="mb-10">
                        <h3 className="text-xl font-medium mb-4 flex items-center gap-2">
                            <Icon name="moon" size={18} />
                            Тема оформления
                        </h3>
                        <div className="grid grid-cols-3 gap-4">
                            {themeOptions.map((theme) => (
                                <button 
                                    key={theme.id}
                                    onClick={() => onChangeTheme(theme.id)}
                                    className={`p-4 rounded-xl border capitalize transition-all ${
                                        preferences.theme === theme.id 
                                            ? 'border-white/70 bg-white/5 text-white'
                                            : 'border-white/10 text-zinc-500 hover:border-white/30'
                                    }`}
                                >
                                    {theme.label}
                                </button>
                            ))}
                        </div>
                    </section>

                    <section className="mb-10">
                        <h3 className="text-xl font-medium mb-4">Цветовой акцент</h3>
                        <div className="flex gap-3 flex-wrap">
                            {accentOptions.map((accent) => (
                                <button
                                    key={accent.id}
                                    onClick={() => onChangeAccent(accent.id)}
                                    className={`w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all ${accent.swatch} ${
                                        preferences.accent === accent.id ? 'border-white scale-110' : 'border-transparent opacity-70 hover:opacity-100'
                                    }`}
                                >
                                    {preferences.accent === accent.id && <Icon name="check" size={16} className="text-white" />}
                                </button>
                            ))}
                        </div>
                    </section>

                    <section className="p-6 rounded-xl glass space-y-4">
                        <div className="flex items-center justify-between gap-4 flex-wrap">
                            <div>
                                <h3 className="text-xl font-medium flex items-center gap-2">
                                    <Icon name="shield" size={18} />
                                    Двухфакторная аутентификация
                                </h3>
                                <p className="text-sm text-zinc-400">
                                    {account.isTwoFAEnabled ? '2FA включена, код требуется при входе.' : 'Защитите вход с помощью Google Authenticator.'}
                                </p>
                            </div>
                            <div className="flex gap-2">
                                {account.isTwoFAEnabled ? (
                                    <button onClick={onDisableTwoFA} className="px-4 py-2 rounded-lg bg-rose-500/10 text-rose-400 text-sm hover:bg-rose-500/20 transition-colors">
                                        Отключить 2FA
                                    </button>
                                ) : (
                                    <button onClick={onStartTwoFA} className="px-4 py-2 rounded-lg accent-button text-sm transition-colors">
                                        Настроить 2FA
                                    </button>
                                )}
                            </div>
                        </div>

                        {twoFASetup.qrCode && (
                            <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                                <div className="bg-black/30 rounded-2xl p-4 flex flex-col items-center justify-center border border-white/5">
                                    <img src={twoFASetup.qrCode} alt="QR для 2FA" className="w-40 h-40 object-contain" />
                                    <p className="text-xs text-zinc-400 mt-3 text-center break-all">{twoFASetup.secret || ''}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-zinc-400 mb-3">Сканируйте QR в Google Authenticator и введите 6-значный код.</p>
                                    <input
                                        type="text"
                                        maxLength="6"
                                        value={twoFACode}
                                        onChange={(e) => setTwoFACode(e.target.value.replace(/\D/g, ''))}
                                        className="glass-input w-full rounded-xl px-4 py-3 text-center text-2xl tracking-[0.5em] font-mono"
                                        placeholder="000000"
                                    />
                                    <button
                                        disabled={twoFACode.length !== 6}
                                        onClick={() => {
                                            onVerifyTwoFA(twoFACode);
                                            setTwoFACode('');
                                        }}
                                        className="mt-3 w-full accent-button py-3 rounded-xl font-medium disabled:opacity-40 disabled:cursor-not-allowed"
                                    >
                                        Подтвердить
                                    </button>
                                </div>
                            </div>
                        )}
                    </section>

                    <section className="mt-10">
                        <h3 className="text-xl font-medium mb-4 flex items-center gap-2">
                            <Icon name="list" size={18} />
                            Активные сессии
                        </h3>
                        <div className="space-y-3">
                            {sessions.length === 0 && (
                                <div className="text-sm text-zinc-500 text-center py-6 glass rounded-xl">
                                    Сессий нет. Войдите с нового устройства, чтобы увидеть его здесь.
                                </div>
                            )}
                            {sessions.map((session) => (
                                <div key={session.sessionId} className="glass rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                    <div>
                                        <p className="font-medium text-sm">{session.userAgent || 'Неизвестное устройство'}</p>
                                        <p className="text-xs text-zinc-500">
                                            IP: {session.ip || '—'} • Активность: {formatDateTime(session.lastSeen)}
                                        </p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {session.sessionId === currentSessionId ? (
                                            <span className="text-xs px-3 py-1 rounded-full accent-chip">Текущая сессия</span>
                                        ) : (
                                            <button
                                                onClick={() => onRevokeSession(session.sessionId)}
                                                className="text-sm px-4 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition-colors"
                                            >
                                                Выйти
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>